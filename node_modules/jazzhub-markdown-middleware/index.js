/*
 * Tacks the markdown representation of a requested file to req.rendered_markdown
 * as long as a corresponding markdown file appears in the path, path.
 */
'use strict';

var marked = require('marked');
var path = require('path');
var fs = require('fs');

var getMarkdown = function(req, markdown_path, callback) {
	if (req.dusted_markdown) {
		callback(null, req.dusted_markdown); return;
	}

	fs.readFile(markdown_path, 'utf8', callback);
};

module.exports = function (doc_path) {
	return {
		file: function (req, res, next) {
			if (req.rendered_markdown)
				return next();

			var req_path = req.path;
			if (req_path.match(/\.md$/)) {
				req_path = req_path.replace(/\.md$/, '');
			}

			var markdown_path = path.join(doc_path, req_path) + '.md';
			getMarkdown(req, markdown_path, function(err, markdown) {
				marked(markdown, function (err, content) {
					if (err) {
						return next();
					}

					req.rendered_markdown = content;
					return next();
				});
			});
		},

		directory: function (req, res, next) {
			if (req.rendered_markdown)
				return next();

			var markdown_path = path.join(doc_path, req.path, 'index.md');

			getMarkdown(req, markdown_path, function (err, markdown) {
				marked(markdown, function(err, content) {
					if (err)
						return next();

					req.rendered_markdown = content;
					return next();
				});
			});
		}
	};
};
